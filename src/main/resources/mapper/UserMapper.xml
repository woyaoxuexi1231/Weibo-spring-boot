<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cqut.weibo.dao.UserMapper">

  <resultMap id="BaseResultMap" type="com.cqut.weibo.security.pojo.User">
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="user_name" property="userName" jdbcType="VARCHAR" />
    <result column="user_phone" property="userPhone" jdbcType="VARCHAR" />
    <result column="password" property="password" jdbcType="VARCHAR" />
    <result column="user_sex" property="userSex" jdbcType="VARCHAR" />
    <result column="user_birth" property="userBirth" jdbcType="DATE" />
    <result column="user_desc" property="userDesc" jdbcType="VARCHAR" />
    <result column="user_avatar" property="userAvatar" jdbcType="VARCHAR" />
    <result column="enabled" property="enabled" jdbcType="BIT"/>
    <result column="locked" property="locked" jdbcType="BIT"/>
  </resultMap>
  <resultMap id="UserDtoMap" type="com.cqut.weibo.security.dto.UserDto">
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="user_name" property="userName" jdbcType="VARCHAR" />
    <result column="user_phone" property="userPhone" jdbcType="VARCHAR" />
    <result column="user_sex" property="userSex" jdbcType="VARCHAR" />
    <result column="user_birth" property="userBirth" jdbcType="DATE" />
    <result column="user_desc" property="userDesc" jdbcType="VARCHAR" />
    <result column="user_avatar" property="userAvatar" jdbcType="VARCHAR" />
    <result column="enabled" property="enabled" jdbcType="BIT"/>
    <result column="locked" property="locked" jdbcType="BIT"/>
  </resultMap>
  <insert id="insertUser" parameterType="com.cqut.weibo.security.pojo.User" useGeneratedKeys="true" keyProperty="id">
    insert into user (user_name, user_phone, password, user_sex, user_birth, user_desc, user_avatar
      )
    values (#{userName}, #{userPhone}, #{password}, #{userSex}, #{userBirth}, #{userDesc},#{userAvatar}
      )
  </insert>
  <insert id="insertUserRole">
    insert into user_role(uid, rid) values (#{id},1)
  </insert>
  <update id="updateUser" parameterType="com.cqut.weibo.security.dto.UserDto">
    update user
    set user_name = #{userName},
      user_phone = #{userPhone},
      <if test="password != '' and password != null">
        password = #{password},
      </if>
      user_sex = #{userSex},
      user_desc = #{userDesc},
      user_birth = #{userBirth},
      user_avatar = #{userAvatar}
    where id = #{id,jdbcType=INTEGER}
  </update>
    <update id="deleteByPrimaryKey">
        update user set enabled = #{enabled} where id = #{id}
    </update>
  <update id="updateUserById">
    update user
    set user_name = #{name}
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="authorityChange">
    update user_role
    set rid = #{rid}
    where uid = #{uid}
  </update>
  <delete id="deleteUserById2">
    delete from user where id = #{id}
  </delete>
  <select id="selectAll" resultMap="UserDtoMap">
    select user.id,user_name,user_phone,user_sex,user_birth,user_desc,user_avatar,enabled,locked from user,user_role
    <where>
      <if test="userName != null and userName != ''">
        user_name like concat("%",#{userName},"%")
      </if>
      and user.id=user_role.uid and user_role.rid in (1,3)
    </where>
    limit #{start},#{limit}
  </select>
  <select id="getCount" resultType="java.lang.Integer" >
    select COUNT(*) FROM user,user_role
    <where>
      <if test="userName != null and userName != ''">
        user_name like concat("%",#{userName},"%")
      </if>
      and user.id = user_role.uid and user_role.rid in (1,3)
    </where>
  </select>
  <select id="checkUserIsExist" resultType="java.lang.Integer">
    select id from user where (user_name = #{userName} OR user_phone = #{userPhone})
    <if test="uid != null and uid != ''">
      AND id!=#{uid}
    </if>
  </select>
  <select id="getDefaultAvatar" resultType="java.lang.String">
    select * from def_avt where default_avatar = CONCAT("http://127.0.0.1:8080/image/default_avatar",#{indexOfDefaultAvatar},".jpg")
  </select>
  <select id="selectByPrimaryKey" resultMap="UserDtoMap">
    select id,user_name,user_phone,user_sex,user_birth,user_desc,user_avatar from user where id = #{id}
  </select>
  <select id="loadUserByUsername" resultType="com.cqut.weibo.security.pojo.User">
    select * from user where user_phone = #{userName}
  </select>
  <select id="getUserRolesByUid" resultType="com.cqut.weibo.security.pojo.Role">
    select * from role r,user_role ur where r.id = ur.rid and ur.uid = #{id}
  </select>

  <select id="authoritySelectAll" resultType="com.cqut.weibo.security.dto.AuthorityUserDto">
    select user.id,user_name userName,user_phone userPhone,user_avatar userAvatar,rid roleID from user,user_role
    <where>
      <if test="userName != null and userName != ''">
        user_name like concat("%",#{userName},"%")
      </if>
      and user.id=user_role.uid and user_role.rid in (1,3)
    </where>
    limit #{start},#{limit}
  </select>


</mapper>